name: Run Tests with LocalStack

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: dynamodb,s3,cloudwatch,logs,iam,sts
          DEFAULT_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DEBUG: 1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "awslocal s3 ls || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10.2'

    - name: Install Java (required for PySpark)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-

    - name: Install dependencies
      run: |
        poetry install --no-interaction --no-ansi

    - name: Wait for LocalStack to be ready
      run: |
        echo "Waiting for LocalStack to be ready..."
        max_attempts=30
        attempt=0
        until curl -s http://localhost:4566/_localstack/health | grep -q '"s3": "available"' || [ $attempt -eq $max_attempts ]; do
          echo "Attempt $((++attempt))/$max_attempts: Waiting for LocalStack..."
          sleep 2
        done
        if [ $attempt -eq $max_attempts ]; then
          echo "LocalStack failed to start"
          exit 1
        fi
        echo "LocalStack is ready!"

    - name: Configure AWS CLI for LocalStack
      run: |
        pip install awscli-local[ver1]
        awslocal s3 mb s3://bronze-bucket || true
        awslocal s3 mb s3://iceberg || true
        awslocal dynamodb create-table \
          --table-name gold_table_plain \
          --attribute-definitions AttributeName=id,AttributeType=N \
          --key-schema AttributeName=id,KeyType=HASH \
          --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 || true
        awslocal dynamodb create-table \
          --table-name gold_table_po \
          --attribute-definitions AttributeName=id,AttributeType=N \
          --key-schema AttributeName=id,KeyType=HASH \
          --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 || true
        awslocal logs create-log-group --log-group-name /aws/glue/jobs/pyspark-logs || true
        awslocal logs create-log-stream \
          --log-group-name /aws/glue/jobs/pyspark-logs \
          --log-stream-name plain-bronze || true
        awslocal logs create-log-stream \
          --log-group-name /aws/glue/jobs/pyspark-logs \
          --log-stream-name po-bronze || true

    - name: Set AWS environment variables
      run: |
        echo "AWS_ACCESS_KEY_ID=test" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=test" >> $GITHUB_ENV
        echo "AWS_REGION=us-east-1" >> $GITHUB_ENV
        echo "AWS_DEFAULT_REGION=us-east-1" >> $GITHUB_ENV

    - name: Run tests with coverage
      run: |
        poetry run pytest tests/ \
          --cov=plain \
          --cov=purchase_order \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          -v

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 7
