# SonarCloud Setup Guide

## Prerequisites

- GitHub repository (public or organization with SonarCloud access)
- Coverage reports generated by your tests (already configured)

## Step 1: Create SonarCloud Account

1. Go to https://sonarcloud.io/
2. Click "Log in" and authenticate with GitHub
3. Grant SonarCloud access to your repositories

## Step 2: Create SonarCloud Organization

1. In SonarCloud, click "+" → "Analyze new project"
2. Select your organization or create a new one
3. Note your organization key (you'll need this)

## Step 3: Import Your Project

1. Select `docker_glue_pyspark_demo` repository
2. Choose "With GitHub Actions" as analysis method
3. SonarCloud will generate a token for you

## Step 4: Configure GitHub Secrets

Add these secrets to your GitHub repository (Settings → Secrets and variables → Actions):

1. **SONAR_TOKEN**:

   - Copy the token from SonarCloud
   - In GitHub: New repository secret
   - Name: `SONAR_TOKEN`
   - Value: paste the token

2. **SONAR_ORGANIZATION**:
   - Copy your organization key from SonarCloud
   - In GitHub: New repository secret
   - Name: `SONAR_ORGANIZATION`
   - Value: your organization key (e.g., `your-org-name`)

## Step 5: Update sonar-project.properties

Edit `sonar-project.properties` and replace:

```properties
sonar.projectKey=docker_glue_pyspark_demo
sonar.organization=YOUR_ORG_KEY  # Replace with your actual org key
```

With your actual values:

```properties
sonar.projectKey=your-github-username_docker_glue_pyspark_demo
sonar.organization=your-org-key
```

## Step 6: Push and Verify

```bash
git add sonar-project.properties .github/workflows/test.yml
git commit -m "Add SonarCloud integration"
git push
```

Go to GitHub Actions and watch the workflow run. After completion:

- Check SonarCloud dashboard for analysis results
- View code quality metrics, coverage, and issues

## Configuration Details

### What's Analyzed

- **Source code**: `plain/`, `purchase_order/`
- **Tests**: `tests/`
- **Coverage**: Uses `coverage.xml` from pytest

### What's Excluded

- Python bytecode (`__pycache__`, `*.pyc`)
- Spark metadata (`metastore_db/`, `spark-warehouse/`)
- Virtual environments (`.venv/`)
- Generated files (`warehouse/`)
- Scripts directory

## Viewing Results

1. Go to https://sonarcloud.io/
2. Navigate to your project dashboard
3. View:
   - Code coverage percentage
   - Bugs, vulnerabilities, code smells
   - Technical debt
   - Duplications
   - Security hotspots

## Quality Gates

SonarCloud automatically fails the build if:

- Coverage drops below threshold (configurable)
- New bugs or vulnerabilities are introduced
- Code smells exceed limits

Configure these in SonarCloud → Administration → Quality Gates

## Troubleshooting

### "Could not find a default branch"

- Ensure your repository has at least one commit
- Check that SonarCloud has permission to access the repo

### "Project key already exists"

- Use a unique project key (add your username prefix)
- Update `sonar.projectKey` in `sonar-project.properties`

### "Coverage report not found"

- Verify `coverage.xml` is generated in workspace root
- Check the "Verify coverage reports" step output in GitHub Actions

### "Analysis failed"

- Check SonarCloud logs in GitHub Actions output
- Verify SONAR_TOKEN is correctly set
- Ensure organization key matches your SonarCloud org

## Alternative: Self-Hosted SonarQube

If using self-hosted SonarQube instead of SonarCloud:

1. Replace the scan step in `.github/workflows/test.yml`:

```yaml
- name: SonarQube Scan
  uses: sonarsource/sonarqube-scan-action@master
  env:
    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
```

2. Add `SONAR_HOST_URL` secret pointing to your SonarQube server

3. Update `sonar-project.properties` to remove `sonar.organization`
